#!/usr/sbin/nft -f

flush ruleset

#  Set your DMZ net here
define DMZ = 100.64.11.0/24

#  Machine A
table ip saclass {
   #  Incoming chain
   chain incoming {
      #  Default deny
      type filter hook input priority 0; policy drop;
      #  allow loopback
      iifname lo accept
      #  established connections
      ct state invalid drop
      ct state related,established accept
      #  saclass grader and proxy
      tcp dport {4113,4114} accept
      #  ping
      icmp type {echo-reply,destination-unreachable,echo-request,time-exceeded} accept
      #  ssh from LAN, WAN, DMZ and VPN
      ip saddr {10.21.32.0/24,100.64.0.0/24,$DMZ,198.18.0.0/16} tcp dport 22 accept
      #  Incoming DHCP and NTP
      udp dport {67,123} accept
   }
   #  Outgoing chain
   chain outgoing {
      #  Default allow
      type filter hook output priority 0; policy accept;
      #  Block facebook
      ip daddr 157.240.28.35 drop
   }
   #  Forward chain
   chain forwarding {
      # Default deny
      type filter hook forward priority 0; policy drop;
      #  established connections
      ct state invalid drop
      ct state related,established accept
      #  interface based chains
      iifname "ens192" oifname "ens224" jump WAN2DMZ
      iifname "ens192" oifname "ens256" jump WAN2LAN
      iifname "ens224" oifname "ens192" jump DMZ2WAN
      iifname "ens224" oifname "ens256" jump DMZ2LAN
      iifname "ens256" oifname "ens192" jump LAN2WAN
      iifname "ens256" oifname "ens224" jump LAN2DMZ
   }
   #  WAN to DMZ chain
   chain WAN2DMZ {
      #  ping
      icmp type {echo-reply,destination-unreachable,echo-request,time-exceeded} accept
      #  DNS
      udp dport 53 accept;
      #  ssh, html, grader
      tcp dport {22,80,4113} accept;
   }
   #  WAN to LAN chain
   chain WAN2LAN {
      # only return traffic
   }
   #  DMZ to WAN
   chain DMZ2WAN {
      #  ping
      icmp type {echo-reply,destination-unreachable,echo-request,time-exceeded} accept
      #  DNS
      udp dport 53 accept;
      #  DNS, http, https
      tcp dport {53,80,443} accept;
   }
   #  DMZ to LAN
   chain DMZ2LAN {
      #  ping
      icmp type {echo-reply,destination-unreachable,echo-request,time-exceeded} accept
      #  ssh and NFS
      tcp dport {22,111,2049} accept;
   }
   #  LAN to DMZ
   chain LAN2DMZ {
      #  Allow everything
      ip saddr {10.21.32.0/24} accept;
   }
   #  LAN to WAN
   chain LAN2WAN {
      #  Block facebook
      ip daddr 157.240.28.35 drop
      #  Allow everything else
      ip saddr {10.21.32.0/24} accept;
   }
}
#  NAT LAN to WAN
table ip nat {
   chain POSTROUTING {
      type nat hook postrouting priority srcnat; policy accept;
      oifname "ens192" ip saddr 10.21.32.0/24 masquerade 
   }
}
